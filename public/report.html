<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Happiness Scan Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>
  <style>
    @page { size: A4; margin: 0; }
    @media print {
      body { margin: 0; padding: 0; }
      #report-page { margin: 0; box-shadow: none; }
    }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    body.pdf-render { 
      margin: 0 !important; 
      padding: 0 !important; 
      background: white !important;
      min-height: auto !important;
      display: block !important;
      justify-content: flex-start !important;
      align-items: flex-start !important;
    }
    body.pdf-render #report-page { 
      margin: 0 !important; 
      box-shadow: none !important;
      position: relative !important;
      left: 0 !important;
      top: 0 !important;
      transform: none !important;
    }
    .font-\[\'Poppins\'\] { font-family: 'Poppins', sans-serif; }
    .footer-title {
      font-family: 'Poppins', sans-serif;
      font-size: 8px;
      font-weight: 600;
      color: #9F847D; /* cappuccino */
      line-height: 9px;
      margin-bottom: 2px;
    }
    .footer-content {
      font-family: 'Poppins', sans-serif;
      font-size: 8px;
      font-weight: 500;
      color: #9F847D; /* cappuccino */
      line-height: 11px;
    }
    .intro-text {
      color: #9F847D; /* cappuccino */
    }
    ul.custom-bullets {
      list-style-type: disc;
      padding-left: 8px;
      margin: 0;
    }
    ul.custom-bullets li {
      margin-bottom: 0;
      line-height: 11px;
    }
    ul.custom-bullets li::marker {
      font-size: 6px;
    }
    .no-wrap {
      white-space: nowrap;
    }
  </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen p-4">

  <!-- A4 Container -->
  <div id="report-page" class="w-[595px] h-[842px] relative bg-white overflow-hidden shadow-lg mx-auto">

    <!-- Header -->
    <div class="w-[549px] left-[23px] top-[22px] absolute flex justify-between items-center">
      <img src="/Br-ndLogo.webp" class="h-12 object-contain" alt="BR-ND">
      <img src="/23plusone.png" class="h-5 object-contain" alt="23plusone">
    </div>
    <div class="absolute w-full top-[29px] text-center pointer-events-none">
        <div class="text-base font-semibold font-['Poppins']" style="color: #371B15;">Your Happiness Scan</div>
    </div>

    <!-- Content -->
    <div class="w-[549px] left-[23px] top-[70px] absolute inline-flex flex-col justify-between items-start" style="height: calc(842px - 70px - 23px);">

      <!-- Main Content (Intro + Domains) -->
      <div class="w-full flex flex-col justify-start items-start">

      <!-- Intro -->
      <div class="w-[549px] flex flex-col justify-end items-start">
        <div class="self-stretch inline-flex justify-between items-start">
          <div class="w-80 flex justify-start items-start gap-2.5">
            <div class="flex-1 justify-start text-[8px] font-semibold font-['Poppins']" style="color: #9F847D;">About the Scan</div>
          </div>
          <div class="w-52 flex justify-start items-start mb-1">
            <div class="flex-1 justify-start text-[8px] font-semibold font-['Poppins']" style="color: #9F847D;">Content</div>
          </div>
        </div>
        <div class="self-stretch inline-flex justify-between items-start">
          <div class="flex justify-start items-start gap-2.5">
            <div class="w-80 justify-start text-[8px] font-medium font-['Poppins']" style="line-height: 11px; color: #9F847D;">This report offers a snapshot of the drives that most strongly influence your motivation today. It reflects where your energy is currently focused.<br/><br/>23plusone is a science-based method that visualizes human values. It maps 24 universal emotional drives, visualised in five domains: Safety, Self-development, Ambition, Vitality and Attraction.<br/><br/>The Happiness Scan applies this method to show which drives are most active for you right now — helping you focus on what matters, build stronger connections and create positive impact.</div>
          </div>
          <div class="w-52 inline-flex flex-col justify-start items-start">
            <ul class="custom-bullets text-[8px] font-medium font-['Poppins']" style="line-height: 11px; color: #9F847D; padding-left: 12px;">
              <li style="margin-bottom: 4px;">Overall Profile & Benchmarks – your overall drive score compared with a broader benchmark.</li>
              <li style="margin-bottom: 4px;">Drives Across Domains – your scores for each domain, with short tips to help you reflect and act on your strengths.</li>
              <li>Disclaimer & Quality.</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="self-stretch flex flex-col justify-start items-start">

        <!-- Overall Score -->
        <div class="self-stretch py-3 border-t-[0.50px] border-b-[0.50px] border-stone-400 inline-flex justify-between items-start mt-2">
          <div class="w-80 flex justify-start items-start">
            <div class="flex-1 inline-flex flex-col justify-start items-start">
              <div class="self-stretch inline-flex justify-between items-start">
                <div class="justify-start text-yellow-950 text-[9px] font-semibold font-['Poppins']">Overall Drive Score</div>
                <div id="overallScoreLabel" class="justify-start text-yellow-950 text-[9px] font-semibold font-['Poppins']">-- | --</div>
              </div>
              <div class="self-stretch h-0.5 mt-1.5 bg-neutral-200/95 inline-flex justify-start items-start gap-2 overflow-hidden">
                <div id="overallBar" class="w-0 self-stretch bg-yellow-950 transition-all duration-500"></div>
              </div>
              <div class="self-stretch pt-1.5 inline-flex justify-center items-center gap-2">
                <div id="overallNote" class="flex-1 justify-start text-yellow-950 text-[8px] font-medium font-['Poppins']" style="line-height: 11px;">
                  <!-- Dynamic note inserted here -->
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-start items-start">
            <div class="w-52 self-stretch px-2.5 rounded-lg flex justify-center items-center gap-2">
              <div class="flex-1 justify-start">
                <div class="text-yellow-950 text-[9px] font-semibold font-['Poppins']" style="line-height: 11px;">Benchmarks</div>
                <div class="text-yellow-950 text-[9px] font-medium font-['Poppins']" style="line-height: 11px;">Percentile: <span id="percentile">--</span></div>
                <div class="text-yellow-950 text-[9px] font-medium font-['Poppins']" style="line-height: 11px;">Cohort average: <span id="cohortAvg">--</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Basics -->
        <div class="self-stretch inline-flex justify-between items-start py-1.5">
          <div class="w-80 flex justify-start items-start">
            <div class="flex-1 inline-flex flex-col justify-start items-start">
              <div class="self-stretch inline-flex justify-between items-start">
                <div class="justify-start text-green-500 text-[9px] font-semibold font-['Poppins']">Basics</div>
                <div id="basicsScore" class="justify-start text-green-500 text-[9px] font-semibold font-['Poppins']">-- | --</div>
              </div>
              <div class="self-stretch h-0.5 mt-1.5 bg-neutral-200/95 inline-flex justify-start items-start gap-2 overflow-hidden">
                <div id="basicsFill" class="w-0 self-stretch bg-green-500 transition-all duration-500"></div>
              </div>
              <div class="self-stretch pt-1.5 inline-flex justify-center items-center gap-2">
                <div id="basicsText" class="flex-1 justify-start">
                   <!-- Narrative inserted here -->
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-start items-center">
            <div class="w-52 rounded-md flex justify-start items-start" style="background: #4CAF50;">
              <div id="coachBlock1" class="text-[8px] font-medium font-['Poppins']" style="width: 100%; padding: 2px 8px 10px 8px; line-height: 11px; text-align: left; color: #ffffff;">
                <!-- Coach text -->
              </div>
            </div>
          </div>
        </div>

        <!-- Self-development -->
        <div class="self-stretch inline-flex justify-between items-start py-1.5">
          <div class="w-80 flex justify-start items-start">
            <div class="flex-1 inline-flex flex-col justify-start items-start">
              <div class="self-stretch inline-flex justify-between items-start">
                <div class="justify-start text-amber-500 text-[9px] font-semibold font-['Poppins']">Self-development</div>
                <div id="growthScore" class="justify-start text-amber-500 text-[9px] font-semibold font-['Poppins']">-- | --</div>
              </div>
              <div class="self-stretch h-0.5 mt-1.5 bg-neutral-200/95 inline-flex justify-start items-start gap-2 overflow-hidden">
                <div id="growthFill" class="w-0 self-stretch bg-amber-500 transition-all duration-500"></div>
              </div>
              <div class="self-stretch pt-1.5 inline-flex justify-center items-center gap-2">
                <div id="growthText" class="flex-1 justify-start"></div>
              </div>
            </div>
          </div>
          <div class="flex justify-start items-center">
            <div class="w-52 rounded-md flex justify-start items-start" style="background: #FF9800;">
              <div id="coachBlock2" class="text-[8px] font-medium font-['Poppins']" style="width: 100%; padding: 2px 8px 10px 8px; line-height: 11px; text-align: left; color: #ffffff;"></div>
            </div>
          </div>
        </div>

        <!-- Ambition -->
        <div class="self-stretch inline-flex justify-between items-start py-1.5">
          <div class="w-80 flex justify-start items-start">
            <div class="flex-1 inline-flex flex-col justify-start items-start">
              <div class="self-stretch inline-flex justify-between items-start">
                <div class="justify-start text-fuchsia-700 text-[9px] font-semibold font-['Poppins']">Ambition</div>
                <div id="ambitionScore" class="justify-start text-fuchsia-700 text-[9px] font-semibold font-['Poppins']">-- | --</div>
              </div>
              <div class="self-stretch h-0.5 mt-1.5 bg-neutral-200/95 inline-flex justify-start items-start gap-2 overflow-hidden">
                <div id="ambitionFill" class="w-0 self-stretch bg-fuchsia-700 transition-all duration-500"></div>
              </div>
              <div class="self-stretch pt-1.5 inline-flex justify-center items-center gap-2">
                <div id="ambitionText" class="flex-1 justify-start"></div>
              </div>
            </div>
          </div>
          <div class="flex justify-start items-center">
            <div class="w-52 rounded-md flex justify-start items-start" style="background: #9C27B0;">
              <div id="coachBlock3" class="text-[8px] font-medium font-['Poppins']" style="width: 100%; padding: 2px 8px 10px 8px; line-height: 11px; text-align: left; color: #ffffff;"></div>
            </div>
          </div>
        </div>

        <!-- Vitality -->
        <div class="self-stretch inline-flex justify-between items-start py-1.5">
          <div class="w-80 flex justify-start items-start">
            <div class="flex-1 inline-flex flex-col justify-start items-start">
              <div class="self-stretch inline-flex justify-between items-start">
                <div class="justify-start text-sky-500 text-[9px] font-semibold font-['Poppins']">Vitality</div>
                <div id="vitalityScore" class="justify-start text-sky-500 text-[9px] font-semibold font-['Poppins']">-- | --</div>
              </div>
              <div class="self-stretch h-0.5 mt-1.5 bg-neutral-200/95 inline-flex justify-start items-start gap-2 overflow-hidden">
                <div id="vitalityFill" class="w-0 self-stretch bg-sky-500 transition-all duration-500"></div>
              </div>
              <div class="self-stretch pt-1.5 inline-flex justify-center items-center gap-2">
                <div id="vitalityText" class="flex-1 justify-start"></div>
              </div>
            </div>
          </div>
          <div class="flex justify-start items-center">
            <div class="w-52 rounded-md flex justify-start items-start" style="background: #2196F3;">
              <div id="coachBlock4" class="text-[8px] font-medium font-['Poppins']" style="width: 100%; padding: 2px 8px 10px 8px; line-height: 11px; text-align: left; color: #ffffff;"></div>
            </div>
          </div>
      </div>

        <!-- Attraction -->
        <div class="self-stretch pb-3 border-b-[0.50px] border-stone-400 inline-flex justify-between items-start py-1.5">
          <div class="w-80 flex justify-start items-start">
            <div class="flex-1 inline-flex flex-col justify-start items-start">
              <div class="self-stretch inline-flex justify-between items-start">
                <div class="justify-start text-pink-600 text-[9px] font-semibold font-['Poppins']">Attraction</div>
                <div id="attractionScore" class="justify-start text-pink-600 text-[9px] font-semibold font-['Poppins']">-- | --</div>
              </div>
              <div class="self-stretch h-0.5 mt-1.5 bg-neutral-200/95 inline-flex justify-start items-start gap-2 overflow-hidden">
                <div id="attractionFill" class="w-0 self-stretch bg-pink-600 transition-all duration-500"></div>
              </div>
              <div class="self-stretch pt-1.5 inline-flex justify-center items-center gap-2">
                <div id="attractionText" class="flex-1 justify-start"></div>
              </div>
            </div>
          </div>
          <div class="flex justify-start items-center">
            <div class="w-52 rounded-md flex justify-start items-start" style="background: #E91E63;">
              <div id="coachBlock5" class="text-[8px] font-medium font-['Poppins']" style="width: 100%; padding: 2px 8px 10px 8px; line-height: 11px; text-align: left; color: #ffffff;"></div>
            </div>
          </div>
      </div>

      </div>
      </div>

      <!-- Footer -->
      <div class="self-stretch inline-flex justify-between items-start pt-2">
        <div class="w-80 justify-start">
          <div class="footer-title">Disclaimer</div>
          <div class="footer-content">This is not a clinical assessment. If you have concerns about your mental health or wellbeing, we encourage you to seek support from a qualified health professional.<br/>Percentiles use current NL norms; they may shift as norms evolve.<br/>Privacy: your data is stored securely and can be deleted at any time.</div>
        </div>
        <div class="w-52 inline-flex justify-between items-start">
          <div class="justify-start">
            <div class="footer-title">Confidence & Quality</div>
            <ul class="custom-bullets footer-content">
              <li>Responses: 24/24</li>
              <li>Timeouts: <span id="timeouts">--</span>/24</li>
              <li>Total time: <span id="totalTime">--</span></li>
              <li>Quality flag: <span id="qualityFlag">Pass</span></li>
            </ul>
          </div>
          <div id="footerMeta" class="justify-start text-left footer-content">
            <!-- Version/Date info inserted here -->
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    (function(){
      const params = new URLSearchParams(location.search || '');
      const base64 = params.get('data');
      if ((params.get('preview') || '').toString() === '1') { try { document.body.classList.add('preview'); } catch(_) {} }
      
      let payload = {};
      
      // TEST MODE: Use ?test=1 to load sample data
      if (params.get('test') === '1') {
        payload = {
          selectedCardIds: [1, 3, 4, 7, 8, 10, 12, 14, 21, 22],
          answers: [
            {id: 1, yes: true, time: 1200}, {id: 3, yes: true, time: 800},
            {id: 4, yes: true, time: 950}, {id: 7, yes: true, time: 600},
            {id: 8, yes: true, time: 1100}, {id: 10, yes: true, time: 750},
            {id: 12, yes: true, time: 900}, {id: 14, yes: true, time: 1300},
            {id: 21, yes: true, time: 850}, {id: 22, yes: true, time: 700}
          ],
          results: {
            n1: 58,
            domainAffirmations: { 'Basics': 12, 'Self-development': 16, 'Ambition': 4, 'Vitality': 8, 'Attraction': 0 }
          },
          benchmark: { ihsPercentile: 72, totalResponses: 1250, context: { averageScore: 52 } },
          completionTime: 145
        };
        console.log('TEST MODE: Using sample data');
      } else {
        try {
          if (base64) {
            try { 
              payload = JSON.parse(decodeURIComponent(escape(atob(base64)))); 
            } catch(e1) { 
              console.log('First decode attempt failed:', e1.message);
              try {
                payload = JSON.parse(atob(base64)); 
              } catch(e2) {
                console.log('Second decode attempt failed:', e2.message);
                console.log('Base64 length:', base64.length);
              }
            }
          }
        } catch(e) { 
          console.log('Outer catch error:', e.message);
        }
      }

      const results = payload.results || {};
      const ihs = Number(results.n1 != null ? results.n1 : (results.ihs || 0));
      const avg = Number((payload.benchmark && payload.benchmark.context && payload.benchmark.context.averageScore) || 0);
      const percentile = payload.benchmark && payload.benchmark.ihsPercentile;
      
      // Debug: Log full payload
      console.log('=== REPORT DEBUG ===');
      console.log('Raw base64:', base64 ? base64.substring(0, 50) + '...' : 'null');
      console.log('Full payload:', payload);
      console.log('payload.selectedCardIds:', payload.selectedCardIds);
      console.log('payload.answers:', payload.answers);
      console.log('====================');
      
      // Card selection data from payload
      const selectedCardIds = payload.selectedCardIds || [];
      const answersData = payload.answers || [];
      
      // Card metadata for personalized insights
      const cardMeta = {
        1: { domain: 'Basics', value: 'Idealism', shortInsight: 'making a meaningful difference' },
        2: { domain: 'Basics', value: 'Loyalty', shortInsight: 'living by strong principles' },
        3: { domain: 'Basics', value: 'Connection', shortInsight: 'being part of something bigger' },
        4: { domain: 'Basics', value: 'Warmth', shortInsight: 'caring for others' },
        5: { domain: 'Basics', value: 'Order', shortInsight: 'creating stability and structure' },
        6: { domain: 'Basics', value: 'Safety', shortInsight: 'feeling safe and secure' },
        7: { domain: 'Self-development', value: 'Relaxation', shortInsight: 'letting go and relaxing' },
        8: { domain: 'Self-development', value: 'Play', shortInsight: 'having fun and playing' },
        9: { domain: 'Self-development', value: 'Freedom', shortInsight: 'freedom and independence' },
        10: { domain: 'Self-development', value: 'Creativity', shortInsight: 'expressing creativity' },
        11: { domain: 'Self-development', value: 'Individuality', shortInsight: 'being uniquely yourself' },
        12: { domain: 'Self-development', value: 'Discovery', shortInsight: 'discovering new things' },
        13: { domain: 'Ambition', value: 'Capability', shortInsight: 'developing your talents' },
        14: { domain: 'Ambition', value: 'Achievement', shortInsight: 'achieving and innovating' },
        15: { domain: 'Ambition', value: 'Challenge', shortInsight: 'overcoming challenges' },
        16: { domain: 'Ambition', value: 'Pride', shortInsight: 'feeling proud and confident' },
        17: { domain: 'Ambition', value: 'Appreciation', shortInsight: 'being appreciated and recognized' },
        18: { domain: 'Ambition', value: 'Standing', shortInsight: 'earning respect and status' },
        19: { domain: 'Ambition', value: 'Collection', shortInsight: 'acquiring meaningful things' },
        20: { domain: 'Ambition', value: 'Influence', shortInsight: 'leading and influencing others' },
        21: { domain: 'Vitality', value: 'Fitness', shortInsight: 'staying fit and active' },
        22: { domain: 'Vitality', value: 'Health', shortInsight: 'nourishing your body' },
        23: { domain: 'Attraction', value: 'Beauty', shortInsight: 'appreciating beauty' },
        24: { domain: 'Attraction', value: 'Sensuality', shortInsight: 'embracing sensory pleasure' }
      };
      
      // Get selected cards for a domain
      function getSelectedCardsForDomain(domain) {
        return selectedCardIds
          .filter(id => cardMeta[id] && cardMeta[id].domain === domain)
          .map(id => cardMeta[id]);
      }
      
      // Get fastest response cards (high confidence selections)
      function getFastestCards(count) {
        if (!answersData.length) return [];
        return [...answersData]
          .filter(a => a.yes === true)
          .sort((a, b) => a.time - b.time)
          .slice(0, count)
          .map(a => cardMeta[a.id])
          .filter(Boolean);
      }

      function setText(id, text){ var el = document.getElementById(id); if (el) el.textContent = text; }
      function setWidth(id, pct){ var el = document.getElementById(id); if (el) el.style.width = Math.max(0, Math.min(100, pct)) + '%'; }
      function setHTML(id, html){ var el = document.getElementById(id); if (el) el.innerHTML = html; }

      function bandLabel(v){ if (v >= 66) return 'High'; if (v >= 34) return 'Mid'; return 'Low'; }
      
      // Overall
      setText('overallScoreLabel', ihs ? (ihs + ' | ' + bandLabel(ihs)) : '-- | --');
      setWidth('overallBar', Math.max(0, Math.min(100, ihs)));

      // Percentile
      try {
        if (percentile == null || Number.isNaN(Number(percentile))) {
          setText('percentile', '--');
        } else {
          var topPct = 100 - Number(percentile);
          if (topPct > 50) {
            setText('percentile', 'Bottom ' + Math.round(100 - topPct) + '%');
          } else {
            setText('percentile', 'Top ' + Math.round(topPct) + '%');
          }
        }
      } catch(_) { setText('percentile', '--'); }
      
      setText('cohortAvg', avg ? String(avg) : '--');

      // Quality
      var completion = (payload && payload.completionTime != null) ? payload.completionTime : (results && typeof results.completionTime === 'number' ? results.completionTime : null);
      var timeoutsCount = (payload && payload.unansweredCount != null) ? payload.unansweredCount : (results && typeof results.unansweredCount === 'number' ? results.unansweredCount : null);
      
      // For time, format seconds to m s
      let timeStr = '--';
      if (completion != null) {
        const m = Math.floor(completion / 60);
        const s = Math.round(completion % 60);
        timeStr = m + 'm ' + s + 's';
      }
      setText('totalTime', timeStr);
      setText('timeouts', (timeoutsCount != null ? String(timeoutsCount) : '0'));

      const max = { 'Basics': 24, 'Self-development': 24, 'Ambition': 32, 'Vitality': 8, 'Attraction': 8 };
      const aff = results.domainAffirmations || {};
      function domainPct(key){ var val = Number(aff[key] || 0); return (val / (max[key]||1)) * 100; }
      const dp = {
        Basics: domainPct('Basics'),
        'Self-development': domainPct('Self-development'),
        Ambition: domainPct('Ambition'),
        Vitality: domainPct('Vitality'),
        Attraction: domainPct('Attraction')
      };

      // Domain Scores & Bars
      setWidth('basicsFill', dp['Basics']); setText('basicsScore', Math.round(dp['Basics']) + ' | ' + bandLabel(dp['Basics']));
      setWidth('growthFill', dp['Self-development']); setText('growthScore', Math.round(dp['Self-development']) + ' | ' + bandLabel(dp['Self-development']));
      setWidth('ambitionFill', dp['Ambition']); setText('ambitionScore', Math.round(dp['Ambition']) + ' | ' + bandLabel(dp['Ambition']));
      setWidth('vitalityFill', dp['Vitality']); setText('vitalityScore', Math.round(dp['Vitality']) + ' | ' + bandLabel(dp['Vitality']));
      setWidth('attractionFill', dp['Attraction']); setText('attractionScore', Math.round(dp['Attraction']) + ' | ' + bandLabel(dp['Attraction']));

      // Card grid removed - replaced with bullet points in HTML

      // Narrative Text - Now card-aware
      function narrativeBand(v){ if (v >= 66) return 'high'; if (v >= 34) return 'mid'; return 'low'; }
      
      // Text variation helper - picks random item from array
      function pickVariation(arr) {
        if (!arr || !arr.length) return '';
        return arr[Math.floor(Math.random() * arr.length)];
      }
      
      // Base narratives with text variations for fallback
      const baseNarrative = {
        Basics: {
          low: { 
            headlines: ['Your first step toward deeper connection', 'Standing strong, with room to lean on others', 'From self-reliance to shared support'],
            insights: [
              "You are used to managing a lot on your own. There may be room to let trusted people stand a bit closer to you.",
              "Independence is clearly important to you. Exploring small moments of asking for help could actually make you feel more grounded, not less.",
              "You know how to carry yourself through challenging situations. Inviting others in now and then can turn pressure into shared strength."
            ]
          },
          mid: { 
            headlines: ['Building on a healthy foundation of connection', 'Balancing independence and belonging', 'Your connection toolkit is growing'],
            insights: [
              "You seem to move comfortably between standing on your own feet and being part of a group. Strengthening a few key relationships can deepen that sense of security.",
              "You already have people and places where you feel at home. Investing a little more attention in those bonds can make everyday life feel lighter.",
              "You know how to give and receive support. Naming the relationships that matter most can help you protect and nurture them more consciously."
            ]
          },
          high: { 
            headlines: ['Recognising your role as a connector', 'Community is one of your strengths', 'You help others feel at ease'],
            insights: [
              "You naturally help people feel included and safe. That sense of trust is a quiet but powerful contribution to any team or community.",
              "Being connected to others seems to give you energy. When you protect your own boundaries as well, this quality becomes even more sustainable.",
              "You are often the person others can rely on. Taking a moment to acknowledge that role can help you use it with intention, not just habit."
            ]
          }
        },
        'Self-development': {
          low: { 
            headlines: ['An invitation to rediscover play', 'Making space for your own growth', 'Allowing curiosity back in'],
            insights: [
              "Daily demands may leave little room for lightness or exploration. Small pockets of play and curiosity could bring back a sense of ease and inspiration.",
              "It might feel like there is always something more important than your own interests. Treating even a few minutes a week as 'time for me' can already shift your energy.",
              "You do not need big changes to restart your sense of growth. Gentle experiments—trying something new, learning one small thing—can open that door again."
            ]
          },
          mid: { 
            headlines: ['Making time for curiosity', 'Growth is quietly present', 'Feeding your curious mind'],
            insights: [
              "You already know how energising it feels to follow your curiosity. Turning this into a small, regular habit can keep that feeling alive in everyday life.",
              "You seem to enjoy learning and trying new things when you can. Protecting a bit of time for this each week can deepen your sense of progress.",
              "Your curiosity is a helpful compass. Paying attention to what keeps catching your interest can guide your next steps in work and life."
            ]
          },
          high: { 
            headlines: ['Honouring your curiosity', 'Your explorer spirit stands out', 'Discovery keeps you moving'],
            insights: [
              "You approach life with an open and questioning mind. New ideas, skills and perspectives appear to be a strong source of energy for you.",
              "You tend to see the world as something to discover rather than just to get through. Using that attitude deliberately can help you navigate change more easily.",
              "Learning and experimenting seem to come naturally to you. Sharing that mindset with others can make the people around you more open as well."
            ]
          }
        },
        Ambition: {
          low: { 
            headlines: ['Letting ambition be a healthy drive', 'Purpose over pressure', 'Redefining what achievement means'],
            insights: [
              "Your motivation may come more from meaning, connection or enjoyment than from constant push and competition. That can be a very sustainable way to move forward.",
              "You do not have to chase big goals to live a valuable life. Clarifying what 'doing well' means for you personally can bring more calm and direction.",
              "You may prefer steady contribution over being in the spotlight. Recognising the impact you already have can prevent you from underestimating yourself."
            ]
          },
          mid: { 
            headlines: ['Channelling a balanced sense of ambition', 'Goals with personal meaning', 'Directed, sustainable drive'],
            insights: [
              "You seem to have a healthy level of ambition without losing yourself in it. Connecting your goals more clearly to your values can make your efforts feel even more worthwhile.",
              "You are willing to work for what you care about. Defining a few concrete next steps can help turn that motivation into visible progress.",
              "You can push yourself, but you also know when to slow down. Keeping that balance in mind protects both your performance and your well-being."
            ]
          },
          high: { 
            headlines: ['Leading with focused ambition', 'Your drive is a real strength', 'Using your energy for impact'],
            insights: [
              "You have a strong inner drive to achieve and move things forward. When you link this clearly to a purpose you believe in, it becomes a powerful force for good.",
              "You seem to set the bar high for yourself. Remembering that rest and perspective are part of performance can keep your ambition from turning into pressure.",
              "You are likely to take initiative and seek growth. Being selective about where you invest that energy helps you create impact without burning out."
            ]
          }
        },
        Vitality: {
          low: { 
            headlines: ['Building your foundation of well-being', 'Listening to what your body needs', 'Starting small with self-care'],
            insights: [
              "Your score suggests that caring for your body and energy could use more attention. Small, realistic steps often make more difference than big promises you cannot keep.",
              "It may feel like your body only gets attention when something is wrong. Treating rest, movement and nourishment as everyday basics can gradually change that.",
              "You do not have to change everything at once to feel better. Choosing one gentle habit—sleep, movement or food—and respecting it can already shift how you experience your days."
            ]
          },
          mid: { 
            headlines: ['Turning awareness into steady habits', 'From knowing to doing more consistently', 'Protecting the energy you already have'],
            insights: [
              "You seem to know what helps you feel well. Making a few of those things non-negotiable habits can stabilise your energy over time.",
              "There is already some attention for your body and health. Strengthening one or two routines can turn good intentions into lasting support for yourself.",
              "You are not starting from zero when it comes to vitality. Clarifying which small practices help most can make it easier to prioritise them in busy weeks."
            ]
          },
          high: { 
            headlines: ['Respecting your well-being', 'Your body as a reliable partner', 'Vitality supports everything else'],
            insights: [
              "You clearly treat your health as an important foundation. That quiet discipline lifts both you and the people around you.",
              "You seem to understand your body's signals and act on them. Continuing to listen in this way will help you stay resilient in demanding periods.",
              "Energy and physical care appear to be active priorities for you. Acknowledging that effort can reinforce your commitment to yourself."
            ]
          }
        },
        Attraction: {
          low: { 
            headlines: ['Reconnecting with your senses', 'Noticing more of what is around you', 'Inviting small moments of beauty'],
            insights: [
              "Life may feel quite practical or task-focused at times. Paying a bit more attention to what you see, hear and feel can quietly increase your sense of calm and pleasure.",
              "It is easy to move through the day on autopilot. Pausing now and then to notice a colour, sound or texture can make moments feel fuller without taking extra time.",
              "You do not need big experiences to feel more alive. Allowing simple things—a view, a piece of music, a taste—to register can already change the tone of your day."
            ]
          },
          mid: { 
            headlines: ['Actively designing a richer day', 'Curating moments of enjoyment', 'Bringing more beauty into reach'],
            insights: [
              "You already notice and appreciate pleasant moments. Choosing a few of them on purpose each week can make your life feel more carefully designed, not just experienced.",
              "Aesthetics and atmosphere have some place in your life. Paying attention to which environments lift you can help you create more of them.",
              "You seem to value small pleasures when they appear. Making space for them intentionally can increase your sense of quality in everyday routines."
            ]
          },
          high: { 
            headlines: ['Letting sensory joy support you', 'A refined sense for atmosphere', 'Beauty as a source of energy'],
            insights: [
              "You experience the world strongly through your senses. When you allow for these moments of beauty and enjoyment, they can restore you as well as delight you.",
              "Details in music, food, touch or surroundings clearly matter to you. Using this awareness to shape your environment can make work and home feel more nourishing.",
              "You do not just register what is around you; you savour it. That sensitivity can help you create spaces and moments that others also love to be in."
            ]
          }
        }
      };

      // Special headline variations for 2-card domains (Vitality & Attraction)
      const twoCardDomainHeadlines = {
        Vitality: {
          both: [
            'Your body knows what it needs',
            'Energy as your foundation',
            'Vitality fuels everything',
            'Movement and nourishment matter',
            'Your physical self is a priority',
            'Taking care from the inside out',
            'Health and fitness work together'
          ],
          single: {
            21: ['Fitness drives you', 'Movement is your anchor', 'Your active side shines'],
            22: ['Health guides you', 'Nourishment matters to you', 'Your body is a priority']
          }
        },
        Attraction: {
          both: [
            'Tuned into beauty around you',
            'Your senses are alive',
            'Pleasure and aesthetics guide you',
            'Beauty speaks to you',
            'The sensory world delights you',
            'Attuned to beauty and pleasure',
            'Your aesthetic sense is strong'
          ],
          single: {
            23: ['Beauty catches your eye', 'Aesthetics matter to you', 'Your eye for beauty shines'],
            24: ['Sensory joy guides you', 'Pleasure speaks to you', 'Your senses are attuned']
          }
        }
      };

      // Generate card-aware narrative with text variations
      function buildCardAwareNarrative(domain, pct) {
        const band = narrativeBand(pct);
        const domainCards = getSelectedCardsForDomain(domain);
        const baseData = (baseNarrative[domain] && baseNarrative[domain][band]) || { headlines: [domain], insights: [''] };
        
        // Pick variations
        let headline = pickVariation(baseData.headlines) || baseData.headlines?.[0] || domain;
        let insight = pickVariation(baseData.insights) || baseData.insights?.[0] || '';
        
        // Personalize based on selected cards
        if (domainCards.length > 0) {
          const values = domainCards.map(c => c.value);
          const cardInsights = domainCards.map(c => c.shortInsight);
          const cardIds = selectedCardIds.filter(id => cardMeta[id] && cardMeta[id].domain === domain);
          
          // Special handling for 2-card domains (Vitality & Attraction)
          if (twoCardDomainHeadlines[domain]) {
            const domainHeadlines = twoCardDomainHeadlines[domain];
            if (domainCards.length >= 2) {
              // Both cards selected - use special "both" headlines
              headline = pickVariation(domainHeadlines.both);
            } else if (domainCards.length === 1 && domainHeadlines.single[cardIds[0]]) {
              // Single card - use card-specific headlines
              headline = pickVariation(domainHeadlines.single[cardIds[0]]);
            }
            
            // Add insight openers
            const insightOpeners = domainCards.length >= 2 
              ? [
                  `You are drawn to ${cardInsights.slice(0, 2).join(' and ')}.`,
                  `${cardInsights[0].charAt(0).toUpperCase() + cardInsights[0].slice(1)} and ${cardInsights[1]} matter to you.`,
                  `Your selections reveal a passion for ${cardInsights.slice(0, 2).join(' and ')}.`
                ]
              : [
                  `You value ${cardInsights[0]}.`,
                  `${cardInsights[0].charAt(0).toUpperCase() + cardInsights[0].slice(1)} is important to you.`,
                  `Your connection to ${cardInsights[0]} is clear.`
                ];
            insight = `${pickVariation(insightOpeners)} ${insight}`;
          } else {
            // Standard handling for other domains
            const headlineVariations = [
              `Your ${values[0]}${values[1] ? ' & ' + values[1] : ''} shine through`,
              `${values[0]}${values[1] ? ' and ' + values[1] : ''} drive${values.length === 1 ? 's' : ''} you`,
              `Powered by ${values[0]}${values[1] ? ' & ' + values[1] : ''}`
            ];
            
            if (domainCards.length >= 2) {
              // Multiple cards selected - reference specific values
              headline = pickVariation(headlineVariations);
              const insightOpeners = [
                `You are drawn to ${cardInsights.slice(0, 2).join(' and ')}.`,
                `${cardInsights[0].charAt(0).toUpperCase() + cardInsights[0].slice(1)} and ${cardInsights[1]} matter to you.`,
                `Your selections reveal a passion for ${cardInsights.slice(0, 2).join(' and ')}.`
              ];
              insight = `${pickVariation(insightOpeners)} ${insight}`;
            } else if (domainCards.length === 1) {
              // Single card - focus on that value
              headline = pickVariation([
                `${values[0]} drives you`,
                `Powered by ${values[0]}`,
                `Your ${values[0].toLowerCase()} shines`
              ]);
              const insightOpeners = [
                `You value ${cardInsights[0]}.`,
                `${cardInsights[0].charAt(0).toUpperCase() + cardInsights[0].slice(1)} is important to you.`,
                `Your connection to ${cardInsights[0]} is clear.`
              ];
              insight = `${pickVariation(insightOpeners)} ${insight}`;
            }
          }
        }
        
        return { headline, insight };
      }

      function setNarrative(id, domain, pct){
        const data = buildCardAwareNarrative(domain, pct);
        var html = '<div class="text-stone-950 text-[8px] font-semibold font-[\'Poppins\']" style="line-height: 10px; margin-bottom: 2px;">' + data.headline + '</div>' +
                   '<div class="text-stone-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 10px;">' + data.insight + '</div>';
        setHTML(id, html);
      }

      setNarrative('basicsText', 'Basics', dp['Basics']);
      setNarrative('growthText', 'Self-development', dp['Self-development']);
      setNarrative('ambitionText', 'Ambition', dp['Ambition']);
      setNarrative('vitalityText', 'Vitality', dp['Vitality']);
      setNarrative('attractionText', 'Attraction', dp['Attraction']);

      // Pattern detection
      // Note: 3-card patterns require ALL 3 cards (minMatch: 3) to prevent over-triggering
      // 2-card patterns are more specific by nature
      const patterns = {
        explorer: { name: 'The Explorer', requires: [10, 12], minMatch: 2, insight: 'Your curiosity and imagination work hand in hand. You tend to feel most alive when you can explore, learn and try out new possibilities.' },
        nurturer: { name: 'The Nurturer', requires: [3, 4], minMatch: 2, insight: 'Connection and care are at your core. You often feel most at ease when you can support others in a warm, reliable way.' },
        achiever: { name: 'The Achiever', requires: [13, 14, 15], minMatch: 3, insight: 'You are driven by mastery and visible progress. Clear goals and tangible results tend to give you focus and energy.' },
        freeSpirit: { name: 'The Free Spirit', requires: [7, 8, 9], minMatch: 3, insight: 'You value ease, play and room to move. You flourish when there is space to choose your own pace and enjoy the moment.' },
        groundedLeader: { name: 'The Grounded Leader', requires: [5, 6, 20], minMatch: 3, insight: "Stability and responsibility matter to you. Others are likely to see you as someone who offers direction without losing sight of people's needs." },
        holisticWellness: { name: 'Holistic Wellness', requires: [21, 22, 23], minMatch: 3, insight: 'You see well-being as more than just fitness or food. You pay attention to how body, mind and environment all influence how you feel.' },
        visionaryIdealist: { name: 'The Visionary Idealist', requires: [1, 10, 14], minMatch: 3, insight: 'You are moved by big ideas and meaningful change. You are at your best when you can turn your ideals into concrete projects or actions.' },
        authenticExpression: { name: 'Authentic Expression', requires: [10, 11], minMatch: 2, insight: 'For you, creativity and being yourself are closely linked. You feel most real when you can express your own voice rather than follow the crowd.' },
        statusBuilder: { name: 'The Status Builder', requires: [16, 17, 18], minMatch: 3, insight: 'Recognition and respect are important signals for you. When your efforts are seen, it strengthens your motivation to keep raising the bar.' },
        sensoryConnoisseur: { name: 'The Sensory Connoisseur', requires: [23, 24], minMatch: 2, insight: 'You experience life strongly through your senses. Carefully chosen details in music, food, touch or aesthetics can turn an ordinary moment into something special for you.' },
        // Cross-domain patterns (2-card, more specific combinations)
        balanceSeeker: { name: 'The Balance Seeker', requires: [6, 7, 21], minMatch: 3, crossDomain: true, insight: 'You seek harmony between security and relaxation, stability and vitality. Balance is not passive for you—it is an active practice.' },
        creativeAchiever: { name: 'The Creative Achiever', requires: [10, 14], minMatch: 2, crossDomain: true, insight: 'You do not just create—you create with impact. Innovation is your path to achievement.' },
        connectorAchiever: { name: 'The Connector-Achiever', requires: [3, 14], minMatch: 2, crossDomain: true, insight: 'You build success through relationships. Your achievements feel most meaningful when they strengthen the bonds around you.' },
        mindfulPerformer: { name: 'The Mindful Performer', requires: [22, 15], minMatch: 2, crossDomain: true, insight: 'You push hard but take care of yourself. Sustainable performance matters more to you than short-term wins.' },
        creativeNurturer: { name: 'The Creative Nurturer', requires: [10, 4], minMatch: 2, crossDomain: true, insight: 'You express care through what you create. Your warmth shows up in the things you make and share.' },
        principledVisionary: { name: 'The Principled Visionary', requires: [2, 1], minMatch: 2, crossDomain: true, insight: 'Your loyalty is to a cause greater than yourself. Principles and purpose guide your vision for a better world.' },
        balancedStriver: { name: 'The Balanced Striver', requires: [7, 14], minMatch: 2, crossDomain: true, insight: 'You know when to push and when to pause. Relaxation is not laziness for you—it is fuel for your next achievement.' }
      };
      
      function detectPatterns() {
        const detected = [];
        
        // Cards that are selected very often (top 5) - patterns using only these are less distinctive
        const commonCardIds = [22, 7, 4, 1, 3]; // Health, Relaxation, Warmth, Idealism, Connection
        
        for (const [key, pattern] of Object.entries(patterns)) {
          const matchingCards = pattern.requires.filter(id => selectedCardIds.includes(id));
          const matchCount = matchingCards.length;
          if (matchCount >= pattern.minMatch) {
            // Calculate average response time for matched cards (lower = faster = stronger signal)
            const matchedAnswers = answersData.filter(a => matchingCards.includes(a.id) && a.yes === true);
            const avgResponseTime = matchedAnswers.length > 0 
              ? matchedAnswers.reduce((sum, a) => sum + (a.time || 4000), 0) / matchedAnswers.length 
              : 4000;
            
            // Calculate distinctiveness score:
            // - Cross-domain patterns get a boost (more meaningful combinations)
            // - Patterns with less common cards are more distinctive
            const hasUncommonCard = matchingCards.some(id => !commonCardIds.includes(id));
            const crossDomainBonus = pattern.crossDomain ? 0.15 : 0;
            const distinctivenessBonus = hasUncommonCard ? 0.1 : 0;
            
            // Combined score: match%, cross-domain bonus, distinctiveness, response time
            const score = (matchCount / pattern.requires.length) + crossDomainBonus + distinctivenessBonus;
            
            detected.push({ 
              key, 
              matchCount, 
              matchPct: matchCount / pattern.requires.length,
              avgResponseTime,
              score, // Combined weighted score
              hasUncommonCard,
              ...pattern 
            });
          }
        }
        
        // Sort by: 1) score (includes cross-domain & distinctiveness), 2) faster response time breaks ties
        detected.sort((a, b) => {
          if (b.score !== a.score) return b.score - a.score;
          return a.avgResponseTime - b.avgResponseTime; // faster (lower time) wins
        });
        return detected;
      }
      
      const detectedPatterns = detectPatterns();

      // Overall Note - Card-aware with pattern detection and fastest response values
      try {
        const entries = Object.entries(dp).sort((a,b)=>b[1]-a[1]);
        const fastCards = getFastestCards(3);
        
        // Build fast response text (used in multiple places)
        const fastValuesNotInPattern = (patternCardIds) => {
          const nonPatternFast = fastCards.filter(c => !patternCardIds.includes(c.id)).slice(0, 2);
          if (nonPatternFast.length >= 2) {
            return nonPatternFast.map(c => c.value).join(' & ');
          }
          return null;
        };
        
        // Priority: detected pattern > fast cards > domain names
        if (detectedPatterns.length > 0) {
          // Show primary detected pattern (strongest match)
          const mainPattern = detectedPatterns[0];
          const secondary = detectedPatterns[1];
          
          // Get the card values that triggered this pattern
          const matchedCardIds = mainPattern.requires.filter(id => selectedCardIds.includes(id));
          const matchedValues = matchedCardIds.map(id => cardMeta[id]?.value).filter(Boolean);
          const triggeredBy = matchedValues.length > 0 ? ' (driven by your ' + matchedValues.join(' & ') + ')' : '';
          
          var noteHtml = '<span class="text-yellow-950 text-[8px] font-semibold font-[\'Poppins\']" style="line-height: 11px;">' + mainPattern.name + triggeredBy + ': </span>' +
                         '<span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">' + mainPattern.insight + '</span>';
          
          // Add fast response insight if there are fast cards outside the pattern
          const extraFastValues = fastValuesNotInPattern(matchedCardIds);
          if (extraFastValues) {
            noteHtml += ' <span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">Your quick responses to ' + extraFastValues + ' also reveal strong instincts.</span>';
          } else if (secondary) {
            // Only mention secondary if we do not have extra fast values (to keep text length manageable)
            noteHtml += ' <span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">You also show elements of ' + secondary.name + '.</span>';
          }
          // Encourage looking at coach blocks for growth
          noteHtml += ' <span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">Check the tips below to round out your drives.</span>';
          setHTML('overallNote', noteHtml);
        } else if (fastCards.length >= 2) {
          // Use specific values from fastest responses
          const valuesStr = fastCards.slice(0, 2).map(c => c.value).join(' & ');
          var noteHtml = '<span class="text-yellow-950 text-[8px] font-semibold font-[\'Poppins\']" style="line-height: 11px;">Your quick responses to ' + valuesStr + ' reveal what truly drives you: </span>' +
                         '<span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">these themes are core to who you are.</span>' +
                         ' <span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">Check the tips below to round out your drives.</span>';
          setHTML('overallNote', noteHtml);
        } else if (entries.length >= 2 && entries[0][1] > 0) {
          // Fallback to domain names
          const d1 = entries[0][0];
          const d2 = entries[1][0];
          var noteHtml = '<span class="text-yellow-950 text-[8px] font-semibold font-[\'Poppins\']" style="line-height: 11px;">' + d1 + ' & ' + d2 + '</span>' +
                         '<span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;"> stand out clearly — your reactions here were fast and consistent.</span>' +
                         ' <span class="text-yellow-950 text-[8px] font-medium font-[\'Poppins\']" style="line-height: 11px;">Check the tips below to round out your drives.</span>';
          setHTML('overallNote', noteHtml);
        }
      } catch(_) {}

      // Coaches - Card-specific recommendations
      function coachBand(v){ if (v >= 66) return 'high'; if (v >= 34) return 'mid'; return 'low'; }
      
      // Card-specific coach tips (top 10 cards have multiple variations)
      const cardCoachTips = {
        1: [
          "Choose one issue you care about and take a small, concrete step for it this week.",
          "Ask yourself what kind of world you want to help create, and do one thing today that moves toward it.",
          "Find one way to contribute to a cause you believe in, no matter how small the action."
        ],
        2: "Think of a moment when you stayed true to someone or something and let it remind you what loyalty means to you.",
        3: [
          "Contact someone you would like to feel closer to and send a simple, genuine message.",
          "Think of one person you have not spoken to in a while and reach out with a short, heartfelt note.",
          "Share something meaningful with someone today, even if it is just a thought or memory."
        ],
        4: [
          "Offer a small act of kindness today, such as a check-in, a compliment or practical help.",
          "Notice someone who might need support and offer a small gesture of care.",
          "Do one thing today that makes someone else's day a little easier or brighter."
        ],
        5: "Spend ten minutes bringing order to one small area, like your desk or inbox.",
        6: "Notice one thing that makes you feel safe and make a conscious effort to protect or strengthen it.",
        7: [
          "Plan a short pause today where you intentionally set tasks aside and let your body unwind.",
          "Give yourself permission to do nothing useful for ten minutes and see how it feels.",
          "Find a moment today to breathe slowly and release the tension you are carrying."
        ],
        8: [
          "Do something light and playful today, even if it is only for a few minutes.",
          "Rediscover something you enjoyed as a child and allow yourself to play with it again.",
          "Let yourself be silly or spontaneous today, without worrying about the outcome."
        ],
        9: [
          "Make one decision today that reflects your own preference, even in a small matter.",
          "Say no to one thing that does not serve you, and notice how it feels to protect your freedom.",
          "Choose something today purely because you want to, not because you should."
        ],
        10: [
          "Give yourself twenty minutes to make or shape something, without judging the result.",
          "Start a small creative project today and focus on the process rather than the outcome.",
          "Express an idea in a new way—through writing, drawing, building or any form that calls to you."
        ],
        11: "Name one way in which you differ from others and allow yourself to appreciate it.",
        12: [
          "Learn one new fact, idea or perspective today through a conversation, article or video.",
          "Follow your curiosity somewhere unexpected today and see where it leads.",
          "Ask a question you have been wondering about and spend a few minutes exploring the answer."
        ],
        13: "Practice a skill you value for fifteen minutes and notice what feels a little easier than before.",
        14: "Set one clear, realistic task for today and take it to completion.",
        15: "Choose a manageable challenge you have been postponing and take a first step toward it.",
        16: "Recall one recent achievement and allow yourself a moment to feel quietly proud of it.",
        17: "Express appreciation to someone today in a way that feels natural to you.",
        18: "Take a moment to reflect on how you would like to be seen and check whether your actions match that picture.",
        19: "Look at something you own that matters to you and consider why it deserves its place in your life.",
        20: "Use your influence today to support someone or to move a shared goal a small step forward.",
        21: [
          "Include at least one short moment of movement in your day, such as a walk or a stretch.",
          "Move your body in a way that feels good today, even if only for five minutes.",
          "Step outside for a brief walk and notice how your energy shifts."
        ],
        22: [
          "Make one choice that supports your health today, for example water, fresh food or going to bed on time.",
          "Notice how one healthy choice today makes you feel, and let that guide tomorrow.",
          "Pick one small health ritual—hydration, rest, or movement—and honour it today."
        ],
        23: "Pause to notice one visual detail that you find beautiful, however small.",
        24: "Take time to experience a simple sensory moment fully, such as a taste, scent or touch."
      };
      
      // Base coach tips with variations as fallback
      const baseCoachTips = {
          Basics: {
          low: [
            "Do one small helpful thing for someone else this week.",
            "Offer support to a person around you, even in a modest way.",
            "Practise one act of generosity, such as listening with attention or giving practical help."
          ],
          mid: [
            "Send someone a short message to let them know you are thinking of them.",
            "Reach out to a person you value and suggest a small moment to catch up.",
            "Express appreciation to someone in your circle for something they have done."
          ],
          high: [
            "Reflect on the communities or groups where you help others feel at home.",
            "Notice how your presence influences the atmosphere in a group.",
            "Take a moment to appreciate the trust that people place in you."
          ]
          },
          'Self-development': {
          low: [
            "Set aside five minutes to do something you simply enjoy.",
            "Allow yourself a brief moment of play, without any goal attached.",
            "Return to an activity you used to find light and enjoyable, even for a short while."
          ],
          mid: [
            "Plan a short curiosity break this week to explore a topic that interests you.",
            "Spend some time reading, watching or listening to something that genuinely fascinates you.",
            "Follow one line of interest a bit further than you usually would, just to see where it leads."
          ],
          high: [
            "Share something you have recently discovered with someone who might enjoy it.",
            "Teach or explain one small thing you know well to another person.",
            "Note one area where you would like to deepen your knowledge and consider a next step."
          ]
          },
          Ambition: {
          low: [
            "Use one of your skills today in a way that is helpful for someone or something you care about.",
            "Choose an activity that feels meaningful rather than impressive and give it your attention.",
            "Notice a task you handle reliably and acknowledge the quiet value it brings."
          ],
          mid: [
            "Choose one skill and practise it for a short, focused period.",
            "Define a small, realistic step towards a goal and complete it.",
            "Pay attention to how progress, rather than perfection, feels in your body and mind."
          ],
          high: [
            "Write down what currently motivates you most and see how it links to your values.",
            "Ask yourself where your energy has the greatest positive impact and adjust one action accordingly.",
            "Plan a short pause in your week to step back and reflect on whether your goals still fit you."
          ]
          },
          Vitality: {
          low: [
            "Take a one-minute pause to breathe slowly and soften your shoulders.",
            "Stand up, stretch gently and notice how your body feels.",
            "Choose one simple act of care today, such as drinking water or stepping outside briefly."
          ],
          mid: [
            "Identify one routine that supports your energy and protect it in your schedule.",
            "Add a small restorative moment to your day, like a walk, a stretch or quiet time.",
            "Notice which activities leave you feeling more rested and plan one of them this week."
          ],
          high: [
            "Acknowledge the effort you already invest in your health and energy.",
            "Take a moment to listen to what your body needs today and respond to it.",
            "Consider how your approach to well-being might also inspire someone close to you."
          ]
          },
          Attraction: {
          low: [
            "Pause for a moment and listen carefully to the sounds around you.",
            "Look out of a window or around the room and notice one detail you usually overlook.",
            "Touch an object slowly and focus on its texture and temperature."
          ],
          mid: [
            "Plan one small sensory pleasure into your day, such as a favourite drink or a walk in a pleasant place.",
            "Take a little extra time to arrange your surroundings in a way that feels good to you.",
            "When you notice something pleasant, stay with it for a few breaths before moving on."
          ],
          high: [
            "Intentionally create one simple moment of beauty tomorrow, for yourself or others.",
            "Use your eye for atmosphere to adjust a space you often spend time in.",
            "Share something you find beautiful - a view, a piece of music or an object - with someone else."
          ]
        }
      };
      
      const correlationPriority = {
        Basics: [2, 3, 6, 1, 4, 5], // loyalty, connection, safety, idealism, warmth, order
        'Self-development': [8, 7, 12, 10, 11, 9], // play, relaxation, discovery, creativity, individuality, freedom
        Ambition: [15, 14, 18, 16, 17, 20, 13, 19], // challenge, achievement, standing, pride, appreciation, influence, capability, collection
        Vitality: [21, 22], // fitness, health
        Attraction: [24, 23] // sensuality, beauty
      };
      
      function buildCardAwareCoach(domain, pct) {
        const band = coachBand(pct);
        const domainCardIds = selectedCardIds.filter(id => cardMeta[id] && cardMeta[id].domain === domain);
        const prioritizedMissing = (correlationPriority[domain] || []).filter(id => !domainCardIds.includes(id));
        
        // If cards are missing, surface a suggestion based on correlation priority
        if (prioritizedMissing.length > 0) {
          const firstId = prioritizedMissing[0];
          const cardTip = cardCoachTips[firstId];
          if (Array.isArray(cardTip)) {
            return pickVariation(cardTip);
          }
          if (typeof cardTip === 'string' && cardTip.trim().length > 0) {
            return cardTip;
          }
          const fallback = cardMeta[firstId]?.shortInsight || 'Explore this drive with a small action.';
          return fallback;
        }
        
        // If we have selected cards, randomly pick one and use its tip
        if (domainCardIds.length > 0) {
          // Randomly select from ALL cards in this domain, not just the first
          const randomCardId = domainCardIds[Math.floor(Math.random() * domainCardIds.length)];
          if (cardCoachTips[randomCardId]) {
            const tip = cardCoachTips[randomCardId];
            // Handle both single tips and arrays of variations
            if (Array.isArray(tip)) {
              return pickVariation(tip);
            }
            return tip;
          }
        }
        
        // Fallback to base coach tips with variations
        const tips = baseCoachTips[domain] && baseCoachTips[domain][band];
        if (Array.isArray(tips)) {
          return pickVariation(tips);
        }
        return tips || '';
      }

      function setCoach(id, domain, pct){
        var el = document.getElementById(id);
        if (!el) return;
        var text = buildCardAwareCoach(domain, pct);
        el.textContent = text;
      }

      setCoach('coachBlock1', 'Basics', dp['Basics']);
      setCoach('coachBlock2', 'Self-development', dp['Self-development']);
      setCoach('coachBlock3', 'Ambition', dp['Ambition']);
      setCoach('coachBlock4', 'Vitality', dp['Vitality']);
      setCoach('coachBlock5', 'Attraction', dp['Attraction']);

      // Footer
      // Auto-calculate current quarter and get participant count from benchmark
      var now = new Date();
      var quarter = 'Q' + (Math.floor(now.getMonth() / 3) + 1);
      var year = now.getFullYear();
      var totalResponses = (payload.benchmark && payload.benchmark.totalResponses) || '--';
      var nDisplay = typeof totalResponses === 'number' ? totalResponses.toLocaleString() : totalResponses;
      setHTML('footerMeta', '<br/>Version: v1.2.0<br/>Date: ' + now.toISOString().slice(0,10) + '<br/>Norms Reference: NL<br/>' + year + quarter + ' (n = ' + nDisplay + ')');

      try { window.__REPORT_READY__ = true; } catch(_) {}
    })();
  </script>
</body>
</html>
